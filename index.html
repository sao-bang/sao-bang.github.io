<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warzone Ultra - Sniper Edition</title>
    <style>
        :root { --primary: #ff4655; --bg-glass: rgba(0, 0, 0, 0.85); }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        
        #menu-ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-glass); padding: 30px; border-radius: 10px; color: white; text-align: center; z-index: 1000; width: 320px; border: 2px solid var(--primary); box-shadow: 0 0 30px rgba(255, 70, 85, 0.3); }
        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 20px; height: 20px; pointer-events: none; z-index: 100; display: none; }
        #crosshair:before, #crosshair:after { content: ''; position: absolute; background: #00ff00; }
        #crosshair:before { top: 50%; width: 100%; height: 2px; transform: translateY(-50%); }
        #crosshair:after { left: 50%; width: 2px; height: 100%; transform: translateX(-50%); }

        #chat-container { position: absolute; bottom: 30px; left: 20px; width: 350px; z-index: 500; pointer-events: none; }
        #chat-box { height: 120px; overflow-y: auto; background: rgba(0,0,0,0.6); color: white; font-size: 13px; padding: 10px; border-radius: 5px; margin-bottom: 5px; border: 1px solid rgba(255,255,255,0.1); }
        #chat-input { background: rgba(0,0,0,0.95); border: 1px solid var(--primary); color: white; padding: 12px; width: 100%; display: none; pointer-events: auto; box-sizing: border-box; outline: none; }

        .btn { background: var(--primary); color: white; border: none; padding: 12px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; }
        #status { position: absolute; top: 20px; right: 20px; color: white; background: rgba(0,0,0,0.7); padding: 10px; font-size: 12px; border-radius: 5px; border-left: 3px solid var(--primary); }
        
        #hp-ui { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 450px; display: none; flex-direction: column; align-items: center; }
        #player-name-display { color: white; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); margin-bottom: 5px; font-size: 14px; letter-spacing: 1px; text-transform: uppercase; }
        #hp-container { width: 100%; height: 12px; background: rgba(255,255,255,0.1); border-radius: 20px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2); }
        #hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ff4655, #ff8a93); transition: width 0.1s linear; }
        
        #reload-timer { color: #ff4655; font-weight: bold; font-size: 12px; margin-top: 5px; display: none; }
    </style>
</head>
<body>

    <div id="crosshair"></div>
    <div id="status">PLAYER ID: <span id="my-id">...</span></div>
    
    <div id="hp-ui">
        <div id="player-name-display">SOLDIER</div>
        <div id="hp-container">
            <div id="hp-bar"></div>
        </div>
        <div id="reload-timer">RELOADING...</div>
    </div>

    <div id="menu-ui">
        <h1 style="margin:0 0 20px 0; color:var(--primary); font-style: italic;">WARZONE</h1>
        <input type="text" id="p-name" value="Soldier_76" style="width:100%; padding:12px; margin-bottom:15px; background:#111; color:#fff; border:1px solid #444; box-sizing: border-box;">
        <input type="text" id="peer-id-input" placeholder="Partner ID..." style="width:100%; padding:12px; margin-bottom:15px; background:#111; color:#fff; border:1px solid #444; box-sizing: border-box;">
        <button id="start-btn" class="btn">DEPLOY NOW</button>
        <div onclick="copyID()" style="color:#666; font-size:10px; cursor:pointer; margin-top:15px; text-decoration: underline;">COPY MY PEER ID</div>
    </div>

    <div id="chat-container">
        <div id="chat-box"></div>
        <input type="text" id="chat-input" placeholder="Message...">
    </div>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } } </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { EnemyManager, ENEMY_TYPES } from './quai.js';

        let scene, camera, renderer, controls, clock = new THREE.Clock();
        let moveF = false, moveB = false, moveL = false, moveR = false;
        let velocity = new THREE.Vector3(), collidables = [];
        let gunPivot, muzzleFlash, peer, conn, myID, playerHP = 100;
        let isChatting = false, isAiming = false;
        let remotePlayers = {};
        let enemyManager;

        // Biến Súng và Âm thanh
        let canShoot = true;
        const reloadTime = 3000;
        const listener = new THREE.AudioListener();
        const audioLoader = new THREE.AudioLoader();
        const sShoot = new THREE.Audio(listener);
        const sReload = new THREE.Audio(listener);
        const sFootstep = new THREE.Audio(listener);

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB); 
            scene.fog = new THREE.FogExp2(0x87CEEB, 0.002);

            scene.add(new THREE.AmbientLight(0xffffff, 1.2));
            const light = new THREE.DirectionalLight(0xffffff, 1.5);
            light.position.set(100, 200, 100);
            scene.add(light);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 5000);
            camera.add(listener);

            // Tải âm thanh
            audioLoader.load('sound/shoot.mp3', (b) => { sShoot.setBuffer(b); sShoot.setVolume(0.5); });
            audioLoader.load('sound/reload.mp3', (b) => { sReload.setBuffer(b); sReload.setVolume(0.5); });
            audioLoader.load('sound/footstep.mp3', (b) => { sFootstep.setBuffer(b); sFootstep.setLoop(true); sFootstep.setVolume(0.3); });

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.toneMapping = THREE.ReinhardToneMapping;
            document.body.appendChild(renderer.domElement);

            controls = new PointerLockControls(camera, document.body);
            controls.addEventListener('lock', () => {
                document.getElementById('menu-ui').style.display = 'none';
                document.getElementById('crosshair').style.display = 'block';
                document.getElementById('hp-ui').style.display = 'flex';
            });
            controls.addEventListener('unlock', () => {
                if (!isChatting) document.getElementById('menu-ui').style.display = 'block';
                if (sFootstep.isPlaying) sFootstep.stop();
            });

            enemyManager = new EnemyManager(scene, collidables);

            document.getElementById('start-btn').addEventListener('click', () => {
                const partnerID = document.getElementById('peer-id-input').value;
                const playerName = document.getElementById('p-name').value;
                document.getElementById('player-name-display').innerText = playerName;
                if(partnerID) connectTo(partnerID);
                controls.lock();
                spawnEnemiesBatch();
            });

            gunPivot = new THREE.Group();
            camera.add(gunPivot);
            scene.add(camera);

            const loader = new GLTFLoader();
            loader.load('models/spiner.glb', (gltf) => {
                gunPivot.add(gltf.scene);
                gltf.scene.rotation.y = Math.PI;
            }, undefined, () => {
                const g = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.12, 0.8), new THREE.MeshStandardMaterial({color: 0x0a0a0a}));
                gunPivot.add(g);
            });

            muzzleFlash = new THREE.PointLight(0xffaa00, 0, 15);
            muzzleFlash.position.set(0, 0, -1);
            gunPivot.add(muzzleFlash);

            loader.load('models/maplon.glb', (g) => {
                scene.add(g.scene);
                g.scene.traverse(c => { 
                    if(c.isMesh) {
                        collidables.push(c);
                        c.material.roughness = 0.8;
                    }
                });
            }, undefined, () => {
                const floor = new THREE.Mesh(new THREE.PlaneGeometry(1000,1000), new THREE.MeshStandardMaterial({color: 0x444444}));
                floor.rotation.x = -Math.PI/2;
                scene.add(floor);
                collidables.push(floor);
            });

            document.addEventListener('keydown', (e) => {
                if (e.code === 'Enter') { toggleChat(); return; }
                if (isChatting) return;
                if(e.code==='KeyW') moveF=true; if(e.code==='KeyS') moveB=true;
                if(e.code==='KeyA') moveL=true; if(e.code==='KeyD') moveR=true;
                if(e.code==='Space' && Math.abs(velocity.y) < 0.1) velocity.y = 12;
                if((moveF||moveB||moveL||moveR) && !sFootstep.isPlaying && controls.isLocked) sFootstep.play();
            });
            document.addEventListener('keyup', (e) => {
                if(e.code==='KeyW') moveF=false; if(e.code==='KeyS') moveB=false;
                if(e.code==='KeyA') moveL=false; if(e.code==='KeyD') moveR=false;
                if(!moveF && !moveB && !moveL && !moveR) sFootstep.stop();
            });

            window.addEventListener('mousedown', (e) => {
                if(!controls.isLocked) return;
                if(e.button === 0) shoot();
                if(e.button === 2) isAiming = true;
            });
            window.addEventListener('mouseup', (e) => { if(e.button === 2) isAiming = false; });
            window.addEventListener('contextmenu', e => e.preventDefault());

            initPeer();
        }

        function spawnEnemiesBatch() {
            for(let i=0; i<8; i++) {
                enemyManager.spawnEnemy(ENEMY_TYPES.NORMAL, new THREE.Vector3(Math.random()*100-50, 0, Math.random()*100-50));
            }
            enemyManager.spawnEnemy(ENEMY_TYPES.BOSS, new THREE.Vector3(0, 0, -40));
        }

        function shoot() {
            if(!canShoot) return;
            canShoot = false;

            if(sShoot.isPlaying) sShoot.stop();
            sShoot.play();

            muzzleFlash.intensity = 40;
            setTimeout(() => muzzleFlash.intensity = 0, 40);
            gunPivot.position.z += 0.5; // Giật súng mạnh

            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            
            const enemyChildren = enemyManager.enemies.flatMap(e => e.children);
            const hits = ray.intersectObjects(enemyChildren);
            
            if(hits.length > 0) {
                const hitObj = hits[0].object;
                const enemyGroup = hitObj.userData.parent;
                if(enemyGroup && !enemyGroup.userData.isDead) {
                    let dmg = 50; 
                    if(hitObj.userData.part === 'head') dmg = 200;
                    enemyGroup.userData.hp -= dmg;
                    if(enemyGroup.userData.hp <= 0) {
                        enemyGroup.userData.isDead = true;
                        scene.remove(enemyGroup);
                        enemyManager.enemies = enemyManager.enemies.filter(e => e !== enemyGroup);
                    }
                }
            }

            const wallHits = ray.intersectObjects(collidables, true);
            if (wallHits.length > 0) {
                const hit = wallHits[0];
                const points = [new THREE.Vector3(0,-0.2,-0.5).applyMatrix4(camera.matrixWorld), hit.point];
                const line = new THREE.Line(new THREE.BufferGeometry().setFromPoints(points), new THREE.LineBasicMaterial({color: 0xffcc00}));
                scene.add(line);
                setTimeout(() => scene.remove(line), 20);
            }

            // Cơ chế nạp đạn 3s
            document.getElementById('reload-timer').style.display = 'block';
            setTimeout(() => {
                if(sReload.isPlaying) sReload.stop();
                sReload.play();
            }, 600);

            setTimeout(() => {
                canShoot = true;
                document.getElementById('reload-timer').style.display = 'none';
            }, reloadTime);
        }

        function initPeer() {
            peer = new Peer();
            peer.on('open', id => { myID = id; document.getElementById('my-id').innerText = id; });
            peer.on('connection', c => { conn = c; setupConn(); });
        }
        function connectTo(id) { conn = peer.connect(id); setupConn(); }
        function setupConn() {
            conn.on('open', () => {
                addMsg("--- Multi Connected ---");
                conn.on('data', data => {
                    if (data.type === 'chat') addMsg(`${data.name}: ${data.msg}`);
                    if (data.type === 'move') updateRemote(conn.peer, data);
                });
            });
        }

        function updateRemote(id, data) {
            if (!remotePlayers[id]) {
                const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1.6), new THREE.MeshStandardMaterial({color: 0x00ff00}));
                scene.add(body); remotePlayers[id] = body;
            }
            remotePlayers[id].position.set(data.x, data.y + 0.8, data.z);
            remotePlayers[id].rotation.y = data.ry;
        }

        function toggleChat() {
            const input = document.getElementById('chat-input');
            if (!isChatting) {
                isChatting = true; input.style.display = 'block'; input.focus(); controls.unlock();
            } else {
                if (input.value.trim() !== "") {
                    if(conn) conn.send({type:'chat', name: document.getElementById('p-name').value, msg: input.value});
                    addMsg("You: " + input.value);
                }
                input.value = ""; input.style.display = 'none'; isChatting = false; controls.lock();
            }
        }

        function addMsg(txt) {
            const box = document.getElementById('chat-box');
            box.innerHTML += `<div>${txt}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function checkCollision(pos) {
            const dirs = [new THREE.Vector3(0,0,-1), new THREE.Vector3(0,0,1), new THREE.Vector3(1,0,0), new THREE.Vector3(-1,0,0)];
            for(let d of dirs) {
                const r = new THREE.Raycaster(pos, d.applyQuaternion(camera.quaternion).setY(0).normalize(), 0, 1.0);
                if(r.intersectObjects(collidables, true).length > 0) return true;
            }
            return false;
        }

        window.copyID = () => { navigator.clipboard.writeText(myID); alert("ID Copied!"); };

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            if (controls.isLocked) {
                velocity.y -= 30 * delta;
                const oldPos = camera.position.clone();
                let speed = isAiming ? 4.5 : 12;

                if (moveF) controls.moveForward(speed * delta);
                if (moveB) controls.moveForward(-speed * delta);
                if (moveL) controls.moveRight(-speed * delta);
                if (moveR) controls.moveRight(speed * delta);

                if(checkCollision(camera.position)) { camera.position.copy(oldPos); }

                camera.position.y += velocity.y * delta;
                const gRay = new THREE.Raycaster(camera.position, new THREE.Vector3(0,-1,0), 0, 1.6);
                const hits = gRay.intersectObjects(collidables, true);
                if (hits.length > 0) { camera.position.y = hits[0].point.y + 1.6; velocity.y = 0; }
                
                if(camera.position.y < -50) camera.position.set(0, 30, 0);

                enemyManager.update(delta, camera.position, (damage) => {
                    playerHP -= (damage * delta);
                    document.getElementById('hp-bar').style.width = Math.max(0, playerHP) + "%";
                    if(playerHP <= 0) { alert("GAME OVER!"); location.reload(); }
                });

                const adsPos = new THREE.Vector3(0, -0.48, -0.4); 
                const hipPos = new THREE.Vector3(0.5, -0.65, -0.9);
                gunPivot.position.lerp(isAiming ? adsPos : hipPos, delta * 12);
                camera.fov = THREE.MathUtils.lerp(camera.fov, isAiming ? 35 : 75, delta * 10);
                camera.updateProjectionMatrix();

                if (conn && conn.open) conn.send({ type: 'move', x: camera.position.x, y: camera.position.y - 1.6, z: camera.position.z, ry: camera.rotation.y });
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>